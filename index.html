<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アリの巣シミュレーター（発展型）</title>
  <style>
    body {
      margin: 0;
      background: #1a1a1a;
      overflow: hidden;
    }
    canvas {
      display: block;
      background: linear-gradient(to bottom, #665544 10%, #3b2f2f 10%);
    }
  </style>
</head>
<body>
  <canvas id="antCanvas"></canvas>
  <script>
    const canvas = document.getElementById("antCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const surfaceHeight = canvas.height * 0.1;
    const nestCenter = { x: canvas.width / 2, y: surfaceHeight + 60 };

    let ants = [];
    let eggs = [];
    let foodSources = [{ x: canvas.width * 0.7, y: surfaceHeight - 10, radius: 8 }];
    let foodStock = 5;
    let pheromoneMap = [];
    const cellSize = 10;

    const cols = Math.floor(canvas.width / cellSize);
    const rows = Math.floor(canvas.height / cellSize);
    for (let y = 0; y < rows; y++) {
      pheromoneMap[y] = [];
      for (let x = 0; x < cols; x++) {
        pheromoneMap[y][x] = 0;
      }
    }

    const ANT_TYPES = {
      WORKER: 'worker',
      SOLDIER: 'soldier',
      QUEEN: 'queen'
    };

    const queen = {
      x: nestCenter.x,
      y: nestCenter.y,
      type: ANT_TYPES.QUEEN,
      eggTimer: 300
    };

    function spawnEgg() {
      eggs.push({
        x: queen.x + Math.random() * 10 - 5,
        y: queen.y + Math.random() * 10 - 5,
        age: 0,
        stage: 'egg'
      });
    }

    function hatchEggs() {
      for (let i = eggs.length - 1; i >= 0; i--) {
        eggs[i].age++;
        if (eggs[i].age > 50 && eggs[i].stage === 'egg') eggs[i].stage = 'larva';
        if (eggs[i].age > 100 && eggs[i].stage === 'larva') eggs[i].stage = 'pupa';
        if (eggs[i].age > 150 && eggs[i].stage === 'pupa') {
          const angle = Math.random() * Math.PI * 2;
          const isSoldier = Math.random() < 0.2;
          ants.push({
            x: eggs[i].x,
            y: eggs[i].y,
            angle,
            carrying: false,
            digging: true,
            type: isSoldier ? ANT_TYPES.SOLDIER : ANT_TYPES.WORKER
          });
          eggs.splice(i, 1);
        }
      }
    }

    function leavePheromone(x, y) {
      const cx = Math.floor(x / cellSize);
      const cy = Math.floor(y / cellSize);
      if (pheromoneMap[cy] && pheromoneMap[cy][cx] !== undefined) {
        pheromoneMap[cy][cx] = Math.min(1, pheromoneMap[cy][cx] + 0.2);
      }
    }

    function evaporatePheromones() {
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          pheromoneMap[y][x] *= 0.98;
        }
      }
    }

    function getPheromoneGradient(x, y) {
      const cx = Math.floor(x / cellSize);
      const cy = Math.floor(y / cellSize);
      let maxVal = 0;
      let bestAngle = null;
      for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -1; dx <= 1; dx++) {
          const nx = cx + dx;
          const ny = cy + dy;
          if (pheromoneMap[ny] && pheromoneMap[ny][nx] !== undefined) {
            const val = pheromoneMap[ny][nx];
            if (val > maxVal) {
              maxVal = val;
              bestAngle = Math.atan2(dy, dx);
            }
          }
        }
      }
      return bestAngle;
    }

    function updateAnts() {
      ants.forEach(ant => {
        if (ant.type === ANT_TYPES.WORKER) {
          if (ant.carrying) {
            leavePheromone(ant.x, ant.y);
            const dx = nestCenter.x - ant.x;
            const dy = nestCenter.y - ant.y;
            ant.angle = Math.atan2(dy, dx);
            ant.x += Math.cos(ant.angle) * 1.5;
            ant.y += Math.sin(ant.angle) * 1.5;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 10) {
              foodStock++;
              ant.carrying = false;
              ant.angle += Math.random() * Math.PI;
            }
          } else {
            const grad = getPheromoneGradient(ant.x, ant.y);
            if (grad !== null) {
              ant.angle = grad + (Math.random() - 0.5) * 0.2;
            }
            for (let f of foodSources) {
              const dx = f.x - ant.x;
              const dy = f.y - ant.y;
              const dist = Math.sqrt(dx * dx + dy * dy);
              if (dist < f.radius + 2) {
                ant.carrying = true;
                ant.angle = Math.atan2(nestCenter.y - ant.y, nestCenter.x - ant.x);
              }
            }
            ant.x += Math.cos(ant.angle) * 1.5;
            ant.y += Math.sin(ant.angle) * 1.5;
            ant.angle += (Math.random() - 0.5) * 0.1;
          }
        } else if (ant.type === ANT_TYPES.SOLDIER) {
          const radius = 50 + Math.random() * 30;
          ant.angle += (Math.random() - 0.5) * 0.1;
          ant.x = nestCenter.x + Math.cos(ant.angle) * radius;
          ant.y = nestCenter.y + Math.sin(ant.angle) * radius;
        }
      });
    }

    function draw() {
      ctx.fillStyle = "#3b2f2f";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#665544";
      ctx.fillRect(0, 0, canvas.width, surfaceHeight);

      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const val = pheromoneMap[y][x];
          if (val > 0.01) {
            ctx.fillStyle = `rgba(0,255,0,${val * 0.4})`;
            ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
          }
        }
      }

      foodSources.forEach(f => {
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.radius, 0, Math.PI * 2);
        ctx.fillStyle = "#0f0";
        ctx.fill();
      });

      ctx.beginPath();
      ctx.arc(queen.x, queen.y, 6, 0, Math.PI * 2);
      ctx.fillStyle = "#f0c";
      ctx.fill();

      eggs.forEach(e => {
        ctx.beginPath();
        ctx.arc(e.x, e.y, 2, 0, Math.PI * 2);
        ctx.fillStyle = e.stage === 'egg' ? "#fff" : e.stage === 'larva' ? "#ccf" : "#88f";
        ctx.fill();
      });

      ants.forEach(a => {
        ctx.beginPath();
        ctx.arc(a.x, a.y, 2, 0, Math.PI * 2);
        ctx.fillStyle = a.type === ANT_TYPES.WORKER ? (a.carrying ? "#ff0" : "#fff") : "#f44";
        ctx.fill();
      });

      ctx.fillStyle = "#fff";
      ctx.font = "14px sans-serif";
      ctx.fillText("食料: " + foodStock, 20, 20);
    }

    function animate() {
      hatchEggs();
      updateAnts();
      evaporatePheromones();
      draw();
      queen.eggTimer--;
      if (queen.eggTimer <= 0 && foodStock > 0) {
        spawnEgg();
        foodStock--;
        queen.eggTimer = 80 + Math.floor(Math.random() * 20);
      }
      requestAnimationFrame(animate);
    }

    animate();
  </script>
</body>
</html>

